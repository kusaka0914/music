{% load static %}

{% for post in posts %}
    {% if post.user and post.user.username %}
        <div class="post-card">
            {% if post.spotify_link %}
                <div class="spotify-player">
                    <iframe 
                        id="spotify-iframe-{{ post.spotify_link|slice:'31:' }}"
                        src="https://open.spotify.com/embed/track/{{ post.spotify_link|slice:'31:' }}?utm_source=generator" 
                        width="100%" 
                        height="152" 
                        frameborder="0" 
                        allowtransparency="true" 
                        allow="encrypted-media">
                    </iframe>
                </div>
            {% endif %}
            <div class="post-content">
                <div class="post-header">
                    <a href="{% url 'core:profile' post.user.username %}" class="post-user">
                        {% if post.user.profile.avatar %}
                            <img src="{{ post.user.profile.avatar.url }}" alt="{{ post.user.username }}">
                        {% else %}
                            <img src="{% static 'images/default-avatar.svg' %}" alt="{{ post.user.username }}">
                        {% endif %}
                        <span>{{ post.user.username }}</span>
                    </a>
                    <span class="post-time">{{ post.created_at|timesince }}前</span>
                </div>
                {% if post.description %}
                    <p class="post-description">{{ post.description }}</p>
                {% endif %}
                <div class="post-actions">
                    <div class="action-group">
                        <button class="like-button {% if user in post.likes.all %}liked{% endif %}" 
                                data-post-id="{{ post.id }}"
                                onclick="toggleLike('{{ post.id }}', this)">
                            <i class="bi {% if user in post.likes.all %}bi-heart-fill{% else %}bi-heart{% endif %}"></i>
                        </button>
                        <button class="likes-list-button" onclick="showLikesModal('{{ post.id }}')">
                            <span class="like-count">{{ post.likes.count }}人がいいね</span>
                        </button>
                    </div>
                    <button class="comment-button" 
                            data-post-id="{{ post.id }}"
                            onclick="toggleComments('{{ post.id }}')">
                        <i class="bi bi-chat"></i>
                        <span class="comment-count">{{ post.comments.count }}</span>
                        <span class="comment-text">コメントを表示</span>
                    </button>
                </div>
                <div id="comments-{{ post.id }}" class="comments-section" style="display: none;">
                    <div class="comments-list">
                        {% for comment in post.comments.all|slice:":3" %}
                            <div class="comment">
                                <div class="comment-user">
                                    {% if comment.user.profile.avatar %}
                                        <img src="{{ comment.user.profile.avatar.url }}" alt="{{ comment.user.username }}">
                                    {% else %}
                                        <img src="{% static 'images/default-avatar.svg' %}" alt="{{ comment.user.username }}">
                                    {% endif %}
                                </div>
                                <div class="comment-content">
                                    <span class="comment-username">{{ comment.user.username }}</span>
                                    <p class="comment-text">{{ comment.content }}</p>
                                </div>
                            </div>
                        {% endfor %}
                        {% if post.comments.count > 3 %}
                            <a href="{% url 'core:post_detail' post.id %}" class="view-all-comments">
                                すべてのコメントを表示 ({{ post.comments.count }})
                            </a>
                        {% endif %}
                    </div>
                    {% if user.is_authenticated %}
                    <form class="comment-form" data-post-id="{{ post.id }}" onsubmit="submitComment(event, '{{ post.id }}')">
                        <input type="text" name="comment" placeholder="コメントを追加..." class="comment-input">
                        <button type="submit"><i class="bi bi-send"></i></button>
                    </form>
                    {% endif %}
                </div>
            </div>
        </div>
    {% endif %}
{% empty %}
    <div class="no-posts">
        <p>投稿がありません</p>
    </div>
{% endfor %} 